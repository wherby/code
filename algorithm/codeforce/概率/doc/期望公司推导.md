
# 全期望公式 推导

这是一个非常关键的数学直觉问题。这个公式的推导实际上是基于全期望公式（Law of Total Expectation），并对“无效轮”进行了条件概率的重构。
我们可以分两步来理解这个逻辑：
1. 原始的递归定义
最原始的期望关系应该是（包含平局的情况）：

$$dp[i] = 1 + P_{tie}(i) \cdot dp[i] + \sum_{j=1}^{i-1} P(i \to j) \cdot dp[j]$$
其中：
$1$：代表当前这一轮。
$P_{tie}(i) \cdot dp[i]$：如果是平局（概率为 $P_{tie}$），人数没变，我们回到了起点，但多花了一轮。
$\sum P(i \to j) \cdot dp[j]$：如果决出了胜负（人数减少到 $j$），则加上后续的期望。
2. 为什么要除以 $P_{win}(i)$？
我们将上面的公式变形，把含有 $dp[i]$ 的项移到左边：

$$dp[i] (1 - P_{tie}(i)) = 1 + \sum_{j=1}^{i-1} P(i \to j) \cdot dp[j]$$
因为 $1 - P_{tie}(i) = P_{win}(i)$（不平局的概率），所以：

$$dp[i] = \frac{1}{P_{win}(i)} + \frac{\sum_{j=1}^{i-1} P(i \to j) \cdot dp[j]}{P_{win}(i)}$$
这里的 $\frac{1}{P_{win}(i)}$ 就是直到第一次决出胜负所需的期望轮数（几何分布的期望）。

3. 关于 $\frac{\binom{i}{j}}{2^i - 2}$ 的来源
这一步是处理条件概率。
$P(i \to j)$ 是“在所有可能情况中，产生 $j$ 个胜者的概率”。
而在公式中，我们已经提取出了 $\frac{1}{P_{win}(i)}$，这意味着我们现在讨论的是**“已知这一轮已经决出胜负”**的前提。
在“决出胜负”这个样本空间里：
手势组合必须是“两种”（例如石头和剪刀）。
总的非平局组合数是 $3 \times (2^i - 2)$。
其中产生 $j$ 个胜者的组合数是 $3 \times \binom{i}{j}$（因为有 3 种可能的胜负对，每种对子里有 $\binom{i}{j}$ 种方式选出胜者）。
所以，在决出胜负的前提下，剩下 $j$ 个人的概率就是：

$$P(j | win) = \frac{3 \cdot \binom{i}{j}}{3 \cdot (2^i - 2)} = \frac{\binom{i}{j}}{2^i - 2}$$
总结
公式的物理含义是：

$$dp[i] = (\text{等到不平局需要的期望轮数}) + \sum_{j=1}^{i-1} (\text{不平局时转移到 } j \text{ 人的概率} \times dp[j])$$
这种处理方法在处理这类“有概率原地踏步”的随机过程题目时非常通用，能把复杂的无限级数求和简化成简单的代数变形。
需要我帮你把这个逻辑转化为 $O(n^2)$ 的代码实现吗？
