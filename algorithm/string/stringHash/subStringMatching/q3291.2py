# https://leetcode.cn/problems/minimum-number-of-valid-strings-to-form-target-i/description/?envType=daily-question&envId=2024-12-17
from typing import List, Tuple, Optional
from collections import defaultdict,deque

class StringHash:
    def __init__(self,s1):
        n =len(s1)
        self.hls =[0]*(n+1)
        self.pls =[1]*(n+1)
        self.mod = 2<<64
        for i in range(n):
            self.hls[i+1] = (self.hls[i]*131 +(ord(s1[i]) - ord('a')+1))%self.mod
            self.pls[i+1] = (self.pls[i]*131)%self.mod
    
    def query(self,left,right):
        return (self.hls[right]- (self.hls[left]*self.pls[right-left]) % self.mod) % self.mod
    
    

class Solution:
    def minValidStrings(self, words: List[str], target: str) -> int:
        dic = defaultdict(set)
        for word in words:
            m = len(word)
            hs = StringHash(word)
            for i in range(1,m+1):
                dic[i].add(hs.query(0,i))
        n = len(target)
        hs= StringHash(target)
        cnt =0
        cur_r =0
        nxt_r = 0
        for i in range(n):
            l,r = 0, n-i
            
            while l<r:
                mid = (l+r+1)>>1
                if hs.query(i,i+mid) not in dic[mid]:
                    r = mid -1
                else:
                    l=mid 
            nxt_r = max(nxt_r,i+l)
            if i == cur_r:
                if i == nxt_r:
                    return -1
                cur_r = nxt_r
                cnt +=1
            #print(i,cnt,cur_r,nxt_r,l)
        return cnt


            


words =["ssssss","xxxxxxxxxx","ssssss","rrrrrr","nnnnnnnnn","eeeee","pppppppp","aaaaaaa","hhhhhh","qqqqq","lllllll","iiiiiiiiii","nnnnn","rrrrrrrr","ggggg","kkkkkkkk","ooooooo","iiiiiiii","iiiiiiiiii","lllllllll","dddddd","kkkkkkk","ppppppp","fffff","llllllll","fffffff","hhhhhhhhhh","aaaaaaaa","ddddd","oooooooo","gggggggg","mmmmmmmm","eeeeee","eeeeeeeeee","nnnnnnnnn","sssssssss","wwwwwwwwww","dcacdbcadbdadabddccbacbbdabcbbbdbaaacabcacbadcbaaabcdbddbbbcdbcccbabbbcababadbadadcbabcbdbbbddbdcababaadddbcbccaadabcaacdadbcddacdbccbbcadcdbadcaddadcdbbaabadbacbbadaaacdbccaccdddcbdcadbbcdadcbdbccdcdcadcdaadabbdadadbcdcddbadbbcdcdddbabcaccadccdbbdddcbbbccdddcbbcdcbcdacaaabccdcdbcaadccdcaaacccbacdabbbbadbcbaabbabaddbbbcccccddacabcadadbddbbbdcaaabaccdabdbddaadbdabdcaacbbccbbbbcadcabcbcbbbbbcccaadddbadbbabdacccddbddbbadbdcbcbdaabdbbcddbacabcbbccdabcbdacabcccddbdccacabcadddcdcaabcbbbbcbdbcddbbcdcdbbdbddabccbbbcaaabadcbabbbdbdbabbaabcaadbdbbbacdbdcdabdbbdbabcbdadacdddcbbcdcbcbcadcdddbcbbbbbcdccadbabdacbcdabacacadbbdcbbbaaacdcaabcbbbbbbbcdbdbadcccabcbcbcbabcdaacabcdcdcbaaabbdcddcdacddbcaacaddaaaadbccdbaaaaddddbaddcccabdcacbaaccddbcccaacbabaadbbbacdcbbacaaaabbbacdbdbcbbbbbcdcbdcaadbabadcadddcbaadacdbbdaabbcbdaabcdbccbcacaadcabcdacbcadccdcaccdcacbdcaadbdacadbdccccabaaacdabaacdcbbcabdcaadbccbaddbccdabcaacccababaacabdbbbbcdddbcaadabdabcdddddaacaddadbbabdcbcbbbcbcdadbddbabcacccccdbbcadbdbccdbcabcaabaaccadbaaddcddbddaaccccbcadacaadbcbdadbbadabacdabccdcabaacacbabadcbdcddcadabbdabbccdccacabacabbbcbdaaabbacabcdcdcbbaaabcdadcabbcccbadcdadbcaacaccacabaccdaaacadbbbcdbdcacabbdbabcaadadcbaddabcbdbbdbbbdbcacbabadcbadabbcdadbbbcddaadbcdcbbdbccaccaaaaadabbdcacdccbcddacdaabaabbbddcaabbddcbccbccddabddbbcabcadcddccacabdacdaaccbbbbcbababaadacaacaabbdabbaabcddbcadabcaaddaabdadbbdcaadcdcdcbabdadbccbbbccadabadbbdcccdaadaacdadcaccdcabbdacaaccddbacabccababdcddcbccbdaadccdadadcdbbcbcaddaaadbdcdbcddabbcdbabddccadacdbbdbbaccddcccbbaaadaccacbdcdcaaacbdcbabbbacdddaacacdadbdadadcdbaaccbbddbcaacddaacbddccdaccacccdacacdadbdcdddbcdbdacbbbcaacaaaddadddacdcaaddcdaaadacdbcbdbbbdccddaadbdaabbcbdaddbdaaddaabbdaacbcaadabcdccbbcadacdcaddddcabdddacdacaddcaaaccdddaccccbbadbddcaaaabbadbaaadcaacdaaaaaddbddccbcdbcacdcccdbadabbacbdaccaddcccabbdddcbdddcbcbaddaddadcdbbdddacdabdaddcdbbaccddccbbbcaddabadbacacdbdabbbccdabbacbcaabbdccdbcaacaddcadaaababcbdbbaadbbacaccbcababcdacbcadddadbbbdcbdbaacbacbcdaccabdcdbaabccaddddcbacbddbdacabdbadccccbcbbbcdaaaadaadabbbccdbdcdaadcadbbbacdbcadaabaacabdcaccddaabadabcbcbacaabbdbbcddcdbaaabbabadcccbdabbabddaccdabadbccbacacbdbaccbaadacdbaccbadcdbdaadadccdadbdccbdbaacddacbcababaacccccdabcaabcbbddcadaaaacbbdddbcaccbcccacbaacddabcbdcabccbacdbdddcadcbaaabcddddcbabddadddbdccadddaaddacdabacdcccccaddccaadcccbdbbabbbadadbcabdbaadababddaacbdabbccdcdcbcaacdbbdabbbdbcbabdadbdbbcaaaadabddabbaacbdcacaacadacacddccbdddcaabdddccbbdcddacbaadbbbbdcaaaaaacabdcadbdabdccacccabbdbccbdddadcaabacbddacbcbaaabadbacbdccacbdbaadadbccacccacccabaaadbbdcdccccccbddadcacacccaddaababbadbbdccccaacadcaccccdbccbaaaccccbdacacabbcdbabdccdbcdaabdbcdbcccbbbbaccbadbadcdbadcaadcadbbacdcdbdaccbbbabbdbabcdbcccbdbadbdbdabbbcabbabddacdcddababbccaacdcbcbbcdcbcaacaabacadcbaabbddadccbbbcccbbbdcbcdbacbbacacbdbdbabcbbcaaacadbcbdbdbaadadacdadaaccaadbbbbbaddbccacbacdbbcdbcaaabccdcbbbcddbcdaacaddcaaacaabbabcbbccdbbabcabcdccacbadbdccbbbdacbcdcdbbdaaaabcbdbaadaabcddadccdcddccdddbdabcaddbbcddabbaddddbcaaaaddacbcdbddcbdbacdbdddcadcbbaaccddccadcbcabbadbbccbcadabccabbcacbddbaccbcddccaabbadddbbaadadbabddbdcbacbcbddaabcbddcbddbaaccbcbdaacabacdbadacdbdadcbadaabccbbaabadcaadcccbaaacdcbacbddcdaadabddaddcddcddcdaadddaacabcddababbcbbbdadadccadddccadabdabcbaabbaaabcbacdcbbadbddcddddabbabdabaaabcddabddddddcbcddddacadbbacacdaadaccaadccbbadcdabdabbcddcddadacaccdcabccbcbaddcccdbddbccdbccdcaaacaaacaadaabcbbcbaddabacbccdddaabddabbbcdbcbccbddccdcddbaddbbbbcacbccbbbcdaccbbbdabaadccdcacbdacdbccbcccdbdadbcbbdccddbadddbacbabdbadadbadcddcbbdcccabbdabbadccccddadccbadabacdcdcbbdabdaccdbccbdacadadaabdcbcbacbdabbcbacdadbacdadbacaacaddcbabaacdbbdcbccbabbcbcccdabdccabbdbbdcdacabadcddadddabdcdacbbbbddbbabcddbcdccccbdbabbbbacacccbcdddaaaaadababdbbddbddbbabdabbccddbccabdcabcacdabbccaddbdcbabccdbcadcbcabaadbdcbabbbcbccbcbaacbbadbaabbdaadabccbbdbbacbbccababaacccaaccbccdbaddcadddbaaddaadbbdbabbacbadbbadcaadacccdabdabcdbddacadbbacbddcdddacbdcdddbbaabbdbcacbbabddaadbacaddabaddabcdaddbbdbaadcbbdaadacbdacdacccaddbabbacdbaddcdaacddddbcdaaddccdacabadbcadcdcdbbabddccacbacdbdacbaaadcabbdccbdaacccabbcdcbcadabdadabacbccadbdbcbdccbbddcacabbcdcadaaddcbbababcabbdacccccabbdcdcccdcabcaabaadcadaccbcacbbdbbacdbbdccbadcabdddbacddabbaacbaaddcbcdbccbcadcbdadadaaaccacaccbcdcbdadbdaaaddaaaacdadcdbbaaaadddbaadcbcbbababdcdcbdbbdbdccbdddddcbcbbdadcabacbacdadacaddccbdcdabadbdacccddaabdbcabbbbadccbccdcbbddaacacbdbddadbbbadbdddbcacacdbbcacccbbdcaababdaabacbbdaccbbcdbcabbdcdaddddddbcddcadacacbcdccacbbadcbbbdcbcaaddbbaaadbacdddcacaccbdbcadaaddbcddddbaabacbbacdcabcbcdddadccbdbacbcbacddbbadddcdcbdaaadaabbadbabddacdadaaacadabacdcabcaadddccccbcdcdabcdaacaddacaacddadbbccbbadbabcdbccadacbbcbcabcaadcdbdcacddbbcbaacdaabdddabdbabbcdacacdcbadacadcdcbbacccddcddbdaddcabbbcdbdddcaaddcabaaabbdbacababcabdccdbadcbddbbaaadcbdaddbacacdcbbcbdccaaabadccbcadccdbbcdaaddbaccbccdbddbdbacdcaacccadbbabcaaaabaccccadcaadcaccaabaddcaddaacdaadccbcabcccccbdddcbaadcaadcdbbabbacbccdabccccbdbacbdbbcdadbbcdbdddbbccdbccdccddaabbbbabbcdcbdbcbabaddbcddcdcacdcbcbbaddbcdabbddaadbbcccaabcadd","bbbbbbb","cccccccc","dddddddd","cccccccccc","mmmmmmmmm","bbbbb","zzzzzzzzzz","mmmmmmmmm","eeeeeee","ttttttt","jjjjjjjjj","wwwww","aaaaaaaa","lllllllll","cccccc","sssssss","vvvvvvvv","tttttt","qqqqqqqqq","oooooooo","aaaaaaa","mmmmmmm","uuuuuu","wwwwwwww","uuuuuuuuu","tttttttttt","yyyyyy","nnnnn","kkkkkkkk","pppppppppp","jjjjjj","bbbbbb","hhhhhhhhhh","gggggg","rrrrr","ttttttttt","vvvvvvvvv","bbbbbb","kkkkkkkk","gggggg","xxxxxxx","oooooooooo","vvvvvvv","xxxxxxxx","dddddddddd","yyyyyyyyyy","hhhhhhhh","ppppppppp","ffffffffff","fffff","uuuuuuuuuu","jjjjjjj","rrrrrrr","yyyyyy","zzzzz","uuuuu","zzzzz","jjjjjjjjjj","iiiiii","qqqqqqqq","qqqqqqq","cccccc"]
target ="aaaaaauaaaaaaaaqqaaaqqaassaaaaaaaaaaabttaaaaaaaaaaaaaaaaaaaicajggaaaaaaabbbaaaaaavaaaaaaaaaaaaaddaaaaaaaaaaaaaaaaaaaaaaaaaabbbaaaaaaaaaaaffaaaaamaaaaaaaaooatttaaaaaaaaaaaaaaaaaaaaaammaaagggaaaaaaaaaaaaaaaaaqqqaaaaaalmllbqhhaabbbaaaaaaaaaaazaaaaaaaattaaaaaaaaaaaaaaaaaaaabaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaagaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaannnnggaaaaaaaaaapppaffaaaaaaiaaaaaaaaaaaaaaaaaaaaaxxxxaaaaaaaaanaaaaaaaaaaaaaaaaaaaaaaaaaaaaaannnnaaaaaaaaazaaaaaaaaaaaaaaaaaaataaaaaaaaaaaaabbbaaaaazzasaaaaaaaaaaaaaaaaaaaaaappppmmmmaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaggaaaaaaraaaaaaaaaaaaacaaaaaaaaaaaqqqaaaaaaaaaaaaaaaaaaaaaaaaaaaqaaaaaaaqqaaaaaaaaaaaaaaaaaaaaaapppahhhhhaaaaaaaaaaaaaaiiiiiaaaaaaaaaaaaaaaaaaaaaaaaaaaagggaaaaaaaaeeaaaaaaaaaattttaaaaccaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaalaaaaaaaaaaaaaatttabbcccwwwaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaccccaaaaaaaaaawwwwaaaaaaaeaaaaaaaaaaaaaaaaaaaaaaattttaaaaaaaaaaaaaaaaawwwwpddddaaaaaaaaaattaaabaaaaaaaaaaapvvaaaaaaaaaaaaaaaadcacdbctdbdadabiiccbacbbdabcbbbdbaaacabcacbadcsaaabcnnddbbbcdbcccbabbbcabagadbadadcbbbcbdbebaazzcababaadddbcbccaadabcaacdadbcddacdbppppooocdbadcalladcdbbzabadbacbbadaaacdbccaccdddcbdcadbbcddcacdbcadbdadabddcacdbccdbdadabdggcbacbbrrbcebccbaaacabcacbadcbaaabcdbddbbbwwbcccbabbbcababadbadadcbabcgggbbltffoffabaadpdbcbcyaadabcaacdadmmddkuubccbbcadcdbadcaddadcdbbaabadbacbbadaaacdbccaccdmdcbdcadbbcdakkkdbwwfrrcadcdaffabudadhdbcdcddbasbbidcdddbabfddcadccdbbdddcbbbccdddcbbcdcbcdaclllbnnnggbcwrrccdcahhhhhbzcdabbbbambcbaabbabaddbbttcctxddacabcadadbddbbbdcttttaccvvbdbddaagggabdvaaffbccbbbbcadcabcccbbwwbcccabbbdbadbbabdacdddduddbbadcccbcbdaarrrbcddbacabbbbccdabcbdacabcccdzzdccacabcadddcdcaabcbaffcbdbcddbbcdcdbbdbtttbccbbbcaaabadcbabbbdbdbabbccccaadbbbbbacdbdcdqwdbbdbabcbdadacdddcbbcdcbcbcadczddbcbbbbbcdccadbabdacmcdabawwwwiiiicbbbaaacdcaabcbuubbbbcdbdbadcccabcbcbcbabcdaacabcrrrcbaaaggdcdbeeecddbchhbbbdaaaadbccdbaaaaddddbaddcccabdcacbqqeaaaacccaaooobaadbbbacdcccacaavvbbbaddddcacdbcadbdadabddccbacbbdabcbbbdbaaacabcacbadcbaaabcdbddbbbeebcccbabbbzzbabadbssadfbabcbdbbuddxdcannnllbbbbcbccaadabcaacdaxxcddacdbccbdcadcduadcaddadcdbbmmmmdbacbvabbbacdbccaccjjjcbdsllqqcdadcboooodcdrtdcdaadabbdamrrbcdcddbadbbcdcdddbssssccadcgdbbdoocbbbccdddcbbcdcbcdacaaabccdckkcaadccdcaaacccbacdabubbadbcbaabbalssssbbcccccddacabcadadbddbbbdcaaammmcdabdbddaadbdabdcaiibbccbbbbcadcabcbfbbbbbcccaadddbadbbabdacccddbddbbadbdcbcbdaabdbbwdddcacdbcadbdadabddccbacbbdabcbbzzzzzacabcacbadcbaanncdbddbbbcsscccbabbbuababaddddadxxaacbdibjjjjdcababaadddbcbccaawabcaacdadbcddacdbccbbcadcdbadcaddadcdbbaabadbaaaaadaaacdbccppcdddcbdcadbbcdadcbdbccdcddadcdaadabbdadadbcdcddnndbbcdcdddbabnnnnadccdbgdddcbabccdddcbbcdcbcdacanabeedcdbcaqqccdcaaacccbacdabbbbadbcbaabbadddffbbcccccddacabjjjadbudbbbooatttaccdabdbddaadbdabdcaacbbccbbbbcadcabcbcbbbbbcccasdddbadbbabraciizzbnnbbjjjjcbcbdwwwdbbcdwwacabcbbccdabcbdacamcccddbdccacabcpppdjjjaabcssbbcbdbcddbboocdbbdbddablcbbbcaaabadcbsbbbdbvvabbaabcaadbdbbbacdbdcdabdbbdbuucbdadacdddccccdcacdbcabddddabdddcbawwwwabcbbggbaaacabcacbadcbadctttbcadbdadabdssssacbbnabcbbbdbaaadfbcacbadcbaahhhhbdfffffdbcccbkbbbcababadbtttttbabcbdbbbddppcaballadddbcbccppppbcaackkmbcccacdbccbbcadcdbadcaddadcdbballldbacbbahhhmmmbccaccdddcbdcadbbzzadcbdbccdcdcadcdaadabbdadadbcdcddbadbbydcbddbabcaccadcndbbdddllbeeedddcbbcdcbcdacaaabdkkwwwwwdbdadabddccbacbbdabcbbbdbaaacabcacwwwwbaaabcmmmdbbbcdbcccbabbbcababavvvvadcbabcbdbbbddbdcababkkkkdwwwccaadqqcaaczzdbcddqqqbnntttadddbaeerrrdqddbbnnbadbacbbadaaacdbccsssdddcbdcadmmmdrrcbdbcooodcadcdaadabbdadadbcdcddbadbbcdcdddbabcaccadccdbbddtttbbccdddcbbcdcbcnacaarrrrdcdbcardccuuaaacccbacdcacdbcadbdadabddccbacjjdabcbbbdbaaacabcachhhhbaaabcdbddbbbcdbcccbauuucababadbadadceabcbdbbbddbdcababattddbcbcqaadabccacdadbckdacdbccbbcadcdbadcaddadcgggaabadbacbbadaaacdbccaccdddcbdcadbbcdadcbdbccdcdcajsjjakkkbdadadbcdcddbadbbcdcppdbapppccadcctttddgcbbbccoodcbbcdclcdacaaabccdcdbcabbbcdcaaahhciicdabbooooocrrabbabaddbbbcccccddacabeadadbddjjbdcaaabacbbbbdcbcbcbabadffcabcdcxxuxxabjdcddcdauuuyyynnahhhhhadbccdbaazaddddbaedcccajjjawzzaccddbcccnnhhhbaadbbbacjjjbacaaaabbbacdbdxxxbbbbcdcbdcaadbabadcadddcbaadacdbbdaabbcbdaahcdbccbcacaadcabcdacbcadttdcaccdcacbkkkadbdacadbdccccabaaacdabaacdcbbcabixxadbccbaddbccdqqcaackkvbabaacabdbbwwwwwdbcoadabdxbcdddddaacaddadwbabdckcbbbuucyyybddbabcacccccccbcadbdbccdbcebcaabtttcadbaaddcddbddaaccbbbcadacaadbcbdadbbadabauuabccdcattttacbabadkodaaaaadagbdabbyydccavabauabbbcbdaaabbaaabcdcsssbapabxxxdcabbckkkaocdadbcpppaccachhaccdaaacadbbbcffdcacabbdbabcaadadcbaddabcbdbbubgbdbcttbabadcbadakkhhadbbwwddaadbedcbbdbccaccaaaaadabbdcacdccbcddatttabaabbbdaaaaaiiiiapppaasaaaaauaaaaaaaaaallllaaaaaaaaaaaaaaabbaaaiiiiaaaaaaaaavaayyaaaaaxxaaaaaagaaaaaaaaaaaapaaaiiiiiaaaaaaaaaaaaaaaakkaaannnnaaaaaaaaaaaaaaaaaaaaaaaaaayyyaaaaaaaaaaaaaaaalllaaaaaaaaaaaaaaaaaaaaooaaaaaaaaaaataaaaaaaaaaaaaaaaaaaaaaaaaarraaaaaaaaaaaaaaaaaaaaaqaaaaaaaooppppaakkkkaaaaaaaaddaaaaaaaaaaauaaaaaaaaavvaaaaaaaaaaaaaaaaaaaazaaaaaaaaaaaaaaaaaaaaaaxxxaaaaaaaaaaaaaaaaaaaaaaa"
re =Solution().minValidStrings(["b","ccacc","a"],"cccaaaacba")
#re =Solution().minValidStrings(words,target)
print(re)